name: C/C++ Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        igraph: [true, false]

    name: Build (${{ matrix.igraph && 'with igraph' || 'without igraph' }})

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential autoconf wget \
          zlib1g-dev libbz2-dev liblzma-dev \
          libcurl4-openssl-dev libdeflate-dev libssl-dev

    - name: Install igraph
      if: matrix.igraph
      run: sudo apt-get install -y --no-install-recommends libigraph-dev

    - name: Build htslib 1.23
      run: |
        wget -q https://github.com/samtools/htslib/releases/download/1.23/htslib-1.23.tar.bz2
        tar xjf htslib-1.23.tar.bz2
        cd htslib-1.23
        ./configure --prefix=/usr/local --enable-libcurl
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Configure
      run: |
        autoconf configure.in > configure && chmod +x configure
        if [ "${{ matrix.igraph }}" = "true" ]; then
          ./configure --with-htslib=/usr/local --with-igraph=/usr
        else
          ./configure --with-htslib=/usr/local
        fi

    - name: Build
      run: make -j$(nproc)

    - name: Verify binaries
      run: |
        ./corset --version || true
        ./corset_fasta_ID_changer --version || true
