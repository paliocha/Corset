Corset — v1.10.0
=================

Fork of [Oshlack/Corset](https://github.com/Oshlack/Corset) v1.09.
OpenMP parallelism, htslib 1.23, C++23, optional Leiden community
detection (igraph), and algorithmic optimisations that reduce
wall-clock time from **16+ hours to ~3.5 minutes** on real RNA-Seq data.

Original author: Nadia Davidson (MCRI, Australia).
OpenMP/htslib/C++23 port: Martin Paliocha, 2026.

Benchmarks
----------

All benchmarks run on the NMBU Orion HPC cluster (32 CPUs, 64 GB RAM).
These are plant *de novo* transcriptome datasets from a vernalisation
time-series experiment in temperate grasses (Poaceae).  Each species
was sequenced across 5 time-points × 2 tissues (leaf/root) × 4
biological replicates = 40 RNA-Seq libraries per species.  Trinity
assemblies were quantified with Salmon (`--dumpEq`), and the
equivalence-class files are the input to Corset.

### Datasets

| Species | Code | Trinity contigs | Samples | Groups | Salmon reads |
|---------|------|-----------------|---------|--------|--------------|
| *Festuca pratensis* (meadow fescue) | FPRA | 793,420 | 40 | 10 | ~1.4 B |
| *Bromus maximus* (great brome)      | BMAX | 460,386 | 40 | 10 | ~0.8 B |

### Runtime comparison

| Dataset | Version | Threads | Wall time | Speedup | Unique clusters |
|---------|---------|---------|-----------|---------|-----------------|
| FPRA    | v1.09   | 1       | 11 h 11 min | 1×   | 463,691         |
| FPRA    | v1.10.0 | 32      | **3 min 21 s** | **200×** | 463,540    |
| BMAX    | v1.09   | 1       | 2 h 34 min  | 1×   | 270,870         |
| BMAX    | v1.10.0 | 32      | **2 min 47 s** | **55×** | 270,773    |

### Cluster-assignment comparison (v1.09 vs v1.10.0)

| Metric                         | FPRA    | BMAX    |
|--------------------------------|---------|---------|
| Transcripts                    | 793,420 | 460,386 |
| Same transcript set            | 100%    | 100%    |
| Identical cluster membership   | 95.3%   | 95.5%   |
| Different cluster membership   | 4.7%    | 4.5%    |
| Mean per-transcript Jaccard    | 0.98    | 0.98    |
| v1.09 unique clusters          | 463,691 | 270,870 |
| v1.10 unique clusters          | 463,540 | 270,773 |

The 4–5% difference is expected: Corset uses random read assignment
(`rand_r`) in the log-likelihood ratio test, and the super-cluster
parallelisation changes merge order at distance ties.  Results are
biologically equivalent.


Requirements
------------
- GCC 13+ with C++23 support
- htslib 1.23+ (headers + library)
- zlib, libbz2, liblzma, libcurl, libdeflate
- **Optional:** igraph 1.0+ (for `--algorithm leiden`)


Installation
------------

    ./configure
    make -j$(nproc)
    make install

To specify a non-system htslib:

    ./configure --with-htslib=/path/to/htslib/prefix

To enable Leiden clustering (optional):

    ./configure --with-htslib=/path/to/htslib --with-igraph=/path/to/igraph

If igraph is not found, Corset builds without Leiden support.
Running `--algorithm leiden` without igraph prints an error and exits.


Running
-------

    corset [options] <eq_classes_files ...>

Type `corset` with no arguments for usage information.
Thread count defaults to `OMP_NUM_THREADS`; override with `-t <int>`.

    # Default (hierarchical clustering):
    corset -i salmon_eq_classes -d 0.3 -g g1,g1,g2,g2 *.sf

    # Leiden community detection:
    corset --algorithm leiden -i salmon_eq_classes -d 0.3 -g g1,g1,g2,g2 *.sf

    # Leiden with soft LRT and adaptive kNN:
    corset --algorithm leiden --lrt-softness 2.0 --knn auto \
           -i salmon_eq_classes -d 0.3 -g g1,g1,g2,g2 *.sf

    # Comparison mode (outputs h- and l- prefixed files):
    corset --algorithm both -p my_prefix \
           -i salmon_eq_classes -d 0.3 -g g1,g1,g2,g2 *.sf

### Leiden-specific options

| Flag | Default | Description |
|------|---------|-------------|
| `--lrt-softness <float>` | `0` (hard cutoff) | Sigmoid steepness for soft LRT decay around D_cut. Recommended: `2.0`. |
| `--knn <int\|auto>` | disabled | kNN graph sparsification. `auto` = connectivity-constrained adaptive k per super-cluster. `<int>` = fixed global k. |
| `--algorithm both` | — | Run hierarchical and Leiden in parallel, output `h-` and `l-` prefixed files for comparison. |

More help: https://github.com/Oshlack/Corset/wiki


Container (Apptainer/Singularity)
---------------------------------

    cd containers/corset
    apptainer build --fakeroot corset_1.10.sif Corset.def


Clustering algorithms
---------------------

Corset v1.10 supports two clustering back-ends.  Both share the same
biological foundation: edges are shared-read proportions filtered by a
log-likelihood ratio (LRT) expression test.  They differ in how those
edges are used to form transcript clusters.

### Hierarchical agglomerative clustering (default)

Custom agglomerative algorithm from the original Corset paper
(Davidson & Oshlack 2014).  At each step the closest pair of
transcript groups is merged, provided the LRT does not detect
differential expression between experimental conditions.  The `-d`
threshold is a distance cutoff: merging stops when the next pair's
shared-read proportion drops below it.

**Strengths:**

- *Strict LRT enforcement* — the expression test is a hard gate at
  every merge decision.  If two groups are differentially expressed,
  they are guaranteed to remain separate.
- *Nested output* — multiple `-d` thresholds produce hierarchically
  consistent cluster assignments.  Clusters at `-d 0.5` are strict
  unions of clusters at `-d 0.3`.
- *Fully deterministic* — identical inputs always produce identical
  cluster assignments, gene-count matrices, and downstream DE results.
  This matters for regulated or archival workflows where bit-exact
  reproducibility is required, and for publication where reviewers
  expect identical results from identical inputs.

**Limitation:**

- O(n²) per super-cluster.  Optimised with adjacency-list merges,
  SSE2 intersection, and parallel distance recomputation, but can
  still be slow for outlier super-clusters with >50k transcripts.

### Leiden community detection (`--algorithm leiden`)

Near-linear O(E log n) community detection via igraph's Constant Potts
Model (CPM) implementation (Traag, Waltman & van Eck 2019).  The same
`get_dist()` function builds the graph: transcript pairs with
non-zero shared-read proportion (after LRT filtering) become weighted
edges.  The `-d` threshold is passed as the CPM resolution parameter
(gamma = minimum internal edge density for a community).

**Strengths:**

- *Scalable* — near-linear time makes super-clusters with 500k+
  transcripts tractable where hierarchical clustering would take hours.
- *Resolution-limit free* — CPM is mathematically free of the
  resolution limit that makes modularity-based methods unable to
  detect small communities in large graphs.
- *Full-precision edge weights* — no quantization to 256 levels as in
  the hierarchical distance matrix.

**Optional enhancements (Leiden only):**

- *Soft LRT* (`--lrt-softness`) — replaces the binary LRT gate with a
  sigmoid decay centred at D_cut.  Borderline-differential transcript
  pairs receive a smoothly down-weighted edge instead of hard exclusion.
  This is analogous to DESeq2's shrunken log-fold-changes: uncertain
  pairs contribute proportionally rather than being all-or-nothing.
- *kNN sparsification* (`--knn auto` or `--knn <int>`) — for each
  super-cluster, keeps only the k highest-weight edges per node before
  running Leiden.  Removes spurious low-weight edges from dense
  super-clusters, improving community quality and speed.  In `auto`
  mode, uses a connectivity-constrained binary search (O(log sqrt(n))
  BFS passes) to find the minimum k that preserves the graph's natural
  community structure.

**Limitations:**

- *Soft LRT enforcement* — the LRT filters edges at graph construction
  time (differentially expressed pairs have no edge), but the CPM
  optimizer considers total community quality.  Two transcripts with no
  direct edge can still land in the same community through intermediate
  nodes with sufficient total edge weight.  `--lrt-softness` mitigates
  this by smoothly down-weighting borderline pairs rather than
  hard-zeroing them.
- *Flat partitions* — each `-d` value produces an independent partition;
  partitions at different resolutions are not guaranteed to be nested.
- *Seeded-stochastic* — the Leiden algorithm depends on random node
  visitation order.  The implementation seeds igraph's RNG per
  super-cluster for reproducibility across runs with identical inputs
  and thread counts.  However, the stochasticity is algorithmic, not
  biological: different runs may split a borderline community
  differently, which can shift read counts for marginal genes near the
  DE significance threshold.

### When to use which

| Criterion | Hierarchical | Leiden |
|-----------|:------------:|:------:|
| Super-clusters <50k transcripts | preferred | works |
| Super-clusters >50k transcripts | slow | preferred |
| Strict expression-test enforcement | yes | approximate |
| Nested multi-resolution output | yes | no |
| Bit-exact reproducibility | yes | seeded-reproducible |
| Resolution-limit free | n/a | yes |

For exploratory analyses or when downstream DE testing (e.g., DESeq2 /
edgeR at the gene level) will re-evaluate significance, Leiden's
bounded stochasticity and soft LRT enforcement are acceptable
trade-offs for the speed improvement.  For archival workflows requiring
strict determinism and hard LRT gating, hierarchical is safer.


Key changes from v1.09
----------------------

### Performance
- **Adjacency-list merge** — O(degree) instead of O(n) per merge step
- **Parallel distance recomputation** — OpenMP nested parallelism for
  distance updates after each merge (>128 neighbors threshold)
- **Flat open-addressing hash map** — replaces `std::unordered_map` for
  the distance matrix; ~2–3× better cache locality
- **Early-out per sample** — skips sorted-list intersection when either
  group has zero reads
- **SSE2 block intersection** — 4-way SIMD comparison in `get_dist()`
- **Lazy-deletion max-heap** for closest-pair extraction
- **Weighted union-find** for super-cluster construction

### Architecture
- OpenMP parallel clustering across super-clusters (hierarchical or Leiden)
- Optional Leiden community detection via igraph CPM (`--algorithm leiden`)
- htslib 1.23 (replacing samtools 0.x inline API)
- Full C++23 standard (GCC 13, `-std=c++23`)

See [CHANGELOG.md](CHANGELOG.md) for the complete change list.


License
-------
GNU General Public License.


----
Last Modified, M. Paliocha, 22 February 2026